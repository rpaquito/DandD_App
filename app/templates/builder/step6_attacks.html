{% extends "builder/wizard_base.html" %}

{% block step_subtitle %}Passo 6: Ataques e Magias{% endblock %}

{% block step_content %}
{% set cls = builder_data.get('classe', {}) %}
{% set armas = builder_data.get('armas', []) %}
{% set attrs = builder_data.get('atributos', {}) %}

<!-- Ataques das Armas -->
<div class="card bg-dark border-danger mb-4">
    <div class="card-header border-danger">
        <h5 class="mb-0"><i class="bi bi-lightning me-2"></i>Ataques</h5>
    </div>
    <div class="card-body">
        <p class="text-muted mb-3">Os teus ataques sao calculados automaticamente baseados nas armas escolhidas:</p>

        {% if armas %}
        <div class="table-responsive">
            <table class="table table-dark table-striped">
                <thead>
                    <tr>
                        <th>Arma</th>
                        <th>Bonus de Ataque</th>
                        <th>Dano</th>
                        <th>Tipo</th>
                    </tr>
                </thead>
                <tbody>
                    {% for arma_id in armas %}
                    {% set str_mod = ((attrs.get('forca', 10) - 10) // 2) %}
                    {% set dex_mod = ((attrs.get('destreza', 10) - 10) // 2) %}
                    {% set bonus = str_mod + 2 %}
                    <tr>
                        <td><strong>{{ arma_id|replace('_', ' ')|title }}</strong></td>
                        <td><span class="badge bg-success">+{{ bonus }}</span></td>
                        <td>1d8 + {{ str_mod }}</td>
                        <td><span class="badge bg-secondary">Cortante</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            Nao escolheste nenhuma arma. Podes sempre atacar desarmado (1 + FOR de dano).
        </div>
        {% endif %}

        <div class="alert alert-info mt-3">
            <small>
                <i class="bi bi-info-circle me-2"></i>
                <strong>Bonus de Ataque</strong> = Modificador de atributo + Bonus de Proficiencia (+2 ao nivel 1)<br>
                <strong>Dano</strong> = Dado da arma + Modificador de atributo
            </small>
        </div>
    </div>
</div>

<!-- Magias (se classe tiver) -->
{% if cls.get('magias', False) %}
<div class="card bg-dark border-purple mb-4" style="border-color: #6f42c1 !important;">
    <div class="card-header" style="border-color: #6f42c1 !important;">
        <h5 class="mb-0"><i class="bi bi-stars me-2"></i>Magia</h5>
    </div>
    <div class="card-body">
        <div class="row mb-3">
            <div class="col-md-4">
                <div class="bg-secondary rounded p-3 text-center">
                    <small class="text-muted d-block">Atributo de Magia</small>
                    <strong>{{ cls.get('atributo_magia', 'N/A')|capitalize }}</strong>
                </div>
            </div>
            <div class="col-md-4">
                <div class="bg-secondary rounded p-3 text-center">
                    <small class="text-muted d-block">CD de Magia</small>
                    {% set spell_attr = attrs.get(cls.get('atributo_magia', 'inteligencia'), 10) %}
                    {% set spell_mod = ((spell_attr - 10) // 2) %}
                    <strong>{{ 8 + 2 + spell_mod }}</strong>
                </div>
            </div>
            <div class="col-md-4">
                <div class="bg-secondary rounded p-3 text-center">
                    <small class="text-muted d-block">Bonus de Ataque</small>
                    <strong>+{{ 2 + spell_mod }}</strong>
                </div>
            </div>
        </div>

        {% if cls.get('truques_nivel_1', 0) > 0 %}
        <h6 class="text-muted mb-2">Truques Conhecidos ({{ cls.get('truques_nivel_1', 0) }})</h6>
        <p class="small text-muted mb-3">
            Escolhe os teus truques. Truques podem ser lancados a vontade sem gastar espacos de magia.
        </p>

        <div class="row g-2 mb-4">
            {% set truques_comuns = [
                ('luz', 'Luz', 'Toca num objeto para emitir luz brilhante'),
                ('mao_mago', 'Mao de Mago', 'Cria uma mao espectral que pode manipular objetos'),
                ('rajada_mistica', 'Rajada Mistica', '1d10 forca - ataque a distancia'),
                ('chama_sagrada', 'Chama Sagrada', '1d8 radiante - salvaguarda DES'),
                ('toque_gelido', 'Toque Gelido', '1d8 necrotico - ataque a distancia'),
                ('fogo_fato', 'Fogo Fato', '1d10 fogo - ataque a distancia'),
                ('mensagem', 'Mensagem', 'Sussurra uma mensagem a uma criatura a distancia'),
                ('prestidigitacao', 'Prestidigitacao', 'Pequenos truques magicos'),
                ('orientacao', 'Orientacao', '+1d4 a um teste de habilidade'),
                ('druidismo', 'Druidismo', 'Pequenos efeitos naturais')
            ] %}

            {% for id, nome, desc in truques_comuns %}
            <div class="col-md-4 col-6">
                <label class="selection-card card bg-secondary">
                    <input type="checkbox" name="truques" value="{{ id }}">
                    <div class="card-body py-2">
                        <strong class="small">{{ nome }}</strong>
                        <small class="d-block text-muted">{{ desc }}</small>
                    </div>
                </label>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {% if cls.get('espacos_magia_nivel_1') %}
        <h6 class="text-muted mb-2">Espacos de Magia</h6>
        <div class="row g-2">
            {% for nivel, slots in cls.get('espacos_magia_nivel_1', {}).items() %}
            <div class="col-auto">
                <div class="bg-secondary rounded p-2 text-center">
                    <small class="text-muted d-block">Nivel {{ nivel }}</small>
                    <strong>{{ slots }} espacos</strong>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
</div>
{% else %}
<div class="alert alert-secondary">
    <i class="bi bi-info-circle me-2"></i>
    A tua classe nao tem habilidades magicas ao nivel 1.
</div>
{% endif %}
{% endblock %}

{% block wizard_js %}
<script>
// Limit cantrip selection
const maxTruques = {{ cls.get('truques_nivel_1', 0) }};
let selectedTruques = 0;

document.querySelectorAll('input[name="truques"]').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        if (this.checked) {
            selectedTruques++;
            if (selectedTruques > maxTruques) {
                this.checked = false;
                this.closest('.selection-card').classList.remove('selected');
                selectedTruques--;
                alert('Podes escolher no maximo ' + maxTruques + ' truques.');
            }
        } else {
            selectedTruques--;
        }
    });
});
</script>
{% endblock %}
