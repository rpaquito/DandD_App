{% extends "base.html" %}

{% block title %}{{ game_session.nome }}{% endblock %}

{% block extra_css %}
<style>
    .player-mini-card {
        transition: transform 0.2s ease;
    }
    .player-mini-card:hover {
        transform: translateY(-2px);
    }
    .hp-bar {
        height: 6px;
        border-radius: 3px;
        background: #333;
        overflow: hidden;
    }
    .hp-fill {
        height: 100%;
        transition: width 0.3s ease;
    }
    .hp-high { background: #28a745; }
    .hp-medium { background: #ffc107; }
    .hp-low { background: #dc3545; }
    .condition-badge {
        font-size: 0.65rem;
        padding: 2px 5px;
    }
    .quest-progress {
        background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
        border-radius: 10px;
    }
    .template-mini {
        cursor: pointer;
        transition: all 0.2s ease;
        border: 2px solid transparent;
    }
    .template-mini:hover {
        border-color: #dc3545;
    }
    .notes-textarea {
        min-height: 100px;
        resize: vertical;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- Sidebar Esquerda - A√ß√µes R√°pidas e Resumo -->
        <div class="col-lg-2 mb-4">
            <!-- Acoes Rapidas -->
            <div class="card bg-dark border-danger mb-4 sticky-top" style="top: 20px;">
                <div class="card-header border-danger">
                    <h6 class="mb-0"><i class="bi bi-lightning me-2"></i>A√ß√µes R√°pidas</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        {% if quest %}
                        <a href="{{ url_for('quest.step', quest_id=quest.id, step_id=game_session.passo_atual, session_id=game_session.id) }}" class="btn btn-sm btn-success">
                            <i class="bi bi-play-fill me-1"></i>Continuar
                        </a>
                        <a href="{{ url_for('quest.overview', quest_id=quest.id, session_id=game_session.id) }}" class="btn btn-sm btn-outline-info">
                            <i class="bi bi-map me-1"></i>Aventura
                        </a>
                        <a href="{{ url_for('quest.npcs', quest_id=quest.id) }}" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-person-circle me-1"></i>NPCs
                        </a>
                        <a href="{{ url_for('quest.monsters', quest_id=quest.id) }}" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-bug me-1"></i>Monstros
                        </a>
                        {% endif %}
                        <a href="{{ url_for('combat.session_tracker', session_id=game_session.id) }}" class="btn btn-sm btn-outline-danger">
                            <i class="bi bi-shield-shaded me-1"></i>Combate
                        </a>
                    </div>
                </div>
            </div>

            <!-- Resumo do Grupo -->
            {% if players %}
            <div class="card bg-dark border-info">
                <div class="card-header border-info">
                    <h6 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Resumo</h6>
                </div>
                <div class="card-body">
                    <div class="row text-center g-2">
                        <div class="col-6">
                            <h5 class="mb-0">{{ players|length }}</h5>
                            <small class="text-muted" style="font-size: 0.7rem;">Jogadores</small>
                        </div>
                        <div class="col-6">
                            {% set total_hp_atual = players|sum(attribute='hp_atual') %}
                            {% set total_hp_max = players|sum(attribute='hp_max') %}
                            <h5 class="mb-0">{{ total_hp_atual }}/{{ total_hp_max }}</h5>
                            <small class="text-muted" style="font-size: 0.7rem;">HP Total</small>
                        </div>
                        <div class="col-6">
                            {% set avg_ac = (players|map(attribute='hp_max')|list|sum / players|length)|round(0)|int if players else 0 %}
                            <h5 class="mb-0">{{ avg_ac }}</h5>
                            <small class="text-muted" style="font-size: 0.7rem;">HP M√©dio</small>
                        </div>
                        <div class="col-6">
                            <h5 class="mb-0">{{ players|selectattr('hp_atual', 'eq', 0)|list|length }}</h5>
                            <small class="text-muted" style="font-size: 0.7rem;">KO</small>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Coluna Principal -->
        <div class="col-lg-7">
            <!-- Cabecalho da Sessao -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1><i class="bi bi-journal-text me-2"></i>{{ game_session.nome }}</h1>
                    <div class="d-flex gap-2 align-items-center">
                        {% if game_session.estado == 'activa' %}
                        <span class="badge bg-success">Activa</span>
                        {% elif game_session.estado == 'pausada' %}
                        <span class="badge bg-warning text-dark">Pausada</span>
                        {% else %}
                        <span class="badge bg-secondary">Terminada</span>
                        {% endif %}
                        <small class="text-muted">
                            <i class="bi bi-clock me-1"></i>
                            Atualizada: {{ game_session.atualizado_em.strftime('%d/%m/%Y %H:%M') if game_session.atualizado_em else 'N/A' }}
                        </small>
                    </div>
                </div>
                <div class="d-flex gap-2">
                    {% if quest %}
                    <a href="{{ url_for('quest.step', quest_id=quest.id, step_id=game_session.passo_atual, session_id=game_session.id) }}" class="btn btn-success">
                        <i class="bi bi-play-fill me-1"></i>Continuar Aventura
                    </a>
                    <a href="{{ url_for('quest.start_quest', quest_id=quest.id) }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-1"></i>Voltar
                    </a>
                    {% else %}
                    <a href="{{ url_for('quest.list_quests') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-1"></i>Voltar
                    </a>
                    {% endif %}
                </div>
            </div>

            <!-- Aventura Atual -->
            <div class="card bg-dark border-secondary mb-4">
                <div class="card-header border-secondary d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-map me-2"></i>Aventura</h5>
                    {% if not quest %}
                    <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#questModal">
                        <i class="bi bi-plus me-1"></i>Selecionar Aventura
                    </button>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if quest %}
                    <div class="quest-progress p-3">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h4 class="mb-1">{{ quest.titulo }}</h4>
                                <p class="text-muted mb-0">{{ quest.descricao }}</p>
                            </div>
                            <span class="badge bg-danger">Nivel {{ quest.nivel_min }}-{{ quest.nivel_max }}</span>
                        </div>

                        <!-- Progresso -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <small>Progresso</small>
                                <small>Passo {{ game_session.passo_atual }} de {{ quest.passos|length }}</small>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-success" style="width: {{ (game_session.passo_atual / quest.passos|length * 100)|int }}%"></div>
                            </div>
                        </div>

                        {% if current_step %}
                        <div class="alert alert-info bg-opacity-10 border-info mb-0">
                            <strong class="text-white">Passo Atual:</strong> <span class="text-white">{{ current_step.titulo }}</span>
                            <span class="badge bg-{{ 'danger' if current_step.tipo == 'combate' else 'info' if current_step.tipo == 'social' else 'warning' if current_step.tipo == 'puzzle' else 'secondary' }} ms-2">
                                {{ current_step.tipo|capitalize }}
                            </span>
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-map display-4 text-muted mb-3"></i>
                        <p class="text-muted">Nenhuma aventura selecionada</p>
                        <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#questModal">
                            <i class="bi bi-plus-circle me-1"></i>Selecionar Aventura
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Jogadores -->
            <div class="card bg-dark border-secondary mb-4">
                <div class="card-header border-secondary d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-people me-2"></i>Jogadores ({{ players|length }})</h5>
                    <button class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#addPlayerModal">
                        <i class="bi bi-plus me-1"></i>Adicionar
                    </button>
                </div>
                <div class="card-body">
                    {% if players %}
                    <div class="row g-3">
                        {% for player in players %}
                        {% set char_data = player.get_character_data() %}
                        <div class="col-md-6">
                            <div class="card bg-secondary player-mini-card">
                                <div class="card-body py-2">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div>
                                            <strong>{{ char_data.get('nome', 'Personagem') }}</strong>
                                            <small class="text-muted d-block">{{ player.nome_jogador }}</small>
                                        </div>
                                        <div class="text-end">
                                            <span class="badge bg-danger">{{ char_data.get('classe', 'N/A') }}</span>
                                            <small class="d-block text-muted">AC {{ char_data.get('ac', 10) }}</small>
                                        </div>
                                    </div>

                                    <!-- HP Bar -->
                                    <div class="mb-2">
                                        <div class="d-flex justify-content-between mb-1">
                                            <small>HP</small>
                                            <small>{{ player.hp_atual }}/{{ player.hp_max }}</small>
                                        </div>
                                        <div class="hp-bar">
                                            {% set hp_percent = (player.hp_atual / player.hp_max * 100)|int if player.hp_max > 0 else 0 %}
                                            <div class="hp-fill {% if hp_percent > 50 %}hp-high{% elif hp_percent > 25 %}hp-medium{% else %}hp-low{% endif %}"
                                                 style="width: {{ hp_percent }}%"></div>
                                        </div>
                                    </div>

                                    <!-- XP Progress Bar -->
                                    {% set player_xp = player.xp_total %}
                                    {% set player_level = char_data.get('nivel', 1) %}
                                    {% if player_level == 1 %}
                                        {% set xp_current_threshold = 0 %}
                                        {% set xp_next_threshold = 300 %}
                                    {% elif player_level == 2 %}
                                        {% set xp_current_threshold = 300 %}
                                        {% set xp_next_threshold = 900 %}
                                    {% elif player_level == 3 %}
                                        {% set xp_current_threshold = 900 %}
                                        {% set xp_next_threshold = 2700 %}
                                    {% else %}
                                        {% set xp_current_threshold = 2700 %}
                                        {% set xp_next_threshold = 6500 %}
                                    {% endif %}
                                    {% set xp_in_level = player_xp - xp_current_threshold %}
                                    {% set xp_needed = xp_next_threshold - xp_current_threshold %}
                                    {% set xp_percent = ((xp_in_level / xp_needed * 100)|int) if xp_needed > 0 else 100 %}

                                    <div class="mb-2">
                                        <div class="d-flex justify-content-between mb-1">
                                            <small class="text-muted">
                                                <i class="bi bi-star me-1"></i>XP
                                            </small>
                                            <small class="text-muted">{{ player_xp }} / {{ xp_next_threshold }}</small>
                                        </div>
                                        <div class="progress" style="height: 6px; background-color: rgba(255,255,255,0.1);">
                                            <div class="progress-bar bg-warning" role="progressbar"
                                                 style="width: {{ xp_percent if xp_percent <= 100 else 100 }}%"></div>
                                        </div>
                                    </div>

                                    <!-- HP Controls -->
                                    <div class="d-flex gap-1 mb-2">
                                        <form action="{{ url_for('session.update_player_hp', session_id=game_session.id, player_id=player.id) }}" method="post" class="d-flex gap-1">
                                            <input type="hidden" name="action" value="damage">
                                            <input type="number" name="amount" value="1" min="1" max="100" class="form-control form-control-sm bg-dark text-light" style="width: 50px;">
                                            <button type="submit" class="btn btn-sm btn-outline-danger"><i class="bi bi-dash"></i></button>
                                        </form>
                                        <form action="{{ url_for('session.update_player_hp', session_id=game_session.id, player_id=player.id) }}" method="post">
                                            <input type="hidden" name="action" value="heal">
                                            <input type="hidden" name="amount" value="1">
                                            <button type="submit" class="btn btn-sm btn-outline-success"><i class="bi bi-plus"></i></button>
                                        </form>
                                        <form action="{{ url_for('session.remove_player', session_id=game_session.id, player_id=player.id) }}" method="post" class="ms-auto"
                                              onsubmit="return confirm('Remover este jogador?');">
                                            <button type="submit" class="btn btn-sm btn-outline-danger"><i class="bi bi-x"></i></button>
                                        </form>
                                    </div>

                                    <!-- Condicoes -->
                                    {% set condicoes = player.get_condicoes() %}
                                    {% if condicoes %}
                                    <div>
                                        {% for cond in condicoes %}
                                        <span class="badge bg-warning text-dark condition-badge">{{ cond }}</span>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-people display-4 text-muted mb-3"></i>
                        <p class="text-muted">Nenhum jogador na sessao</p>
                        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addPlayerModal">
                            <i class="bi bi-plus-circle me-1"></i>Adicionar Primeiro Jogador
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- NPCs Presentes (se houver step atual) -->
            {% if quest and current_step and current_step.npcs and current_step.npcs|length > 0 %}
            <div class="card bg-dark border-info mb-4">
                <div class="card-header border-info">
                    <h5 class="mb-0"><i class="bi bi-people me-2"></i>NPCs Presentes</h5>
                </div>
                <div class="card-body">
                    <div class="row g-2">
                        {% for npc_id in current_step.npcs %}
                        {% if quest.npcs and quest.npcs[npc_id] %}
                        {% set npc = quest.npcs[npc_id] %}
                        <div class="col-md-6">
                            <div class="card bg-secondary h-100">
                                <div class="card-body py-2">
                                    <h6 class="mb-1">{{ npc.nome }}</h6>
                                    <small class="text-light opacity-75 d-block text-wrap" style="word-break: break-word;">{{ npc.descricao[:100] }}{% if npc.descricao|length > 100 %}...{% endif %}</small>
                                    {% if npc.personalidade %}
                                    <div class="mt-2">
                                        <span class="badge bg-info"><i class="bi bi-star me-1"></i>{{ npc.personalidade }}</span>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Monstros (se houver step atual de combate) -->
            {% if quest and current_step and current_step.monstros and current_step.monstros|length > 0 %}
            <div class="card bg-dark border-danger mb-4">
                <div class="card-header border-danger">
                    <h5 class="mb-0"><i class="bi bi-bug me-2"></i>Monstros</h5>
                </div>
                <div class="card-body">
                    <div class="row g-2">
                        {% for monster_id in current_step.monstros %}
                        {% if quest.monstros and quest.monstros[monster_id] %}
                        {% set monster = quest.monstros[monster_id] %}
                        <div class="col-md-6">
                            <div class="card bg-secondary h-100">
                                <div class="card-body py-2">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <h6 class="mb-0">{{ monster.nome }}</h6>
                                        <span class="badge bg-danger">CR {{ monster.cr }}</span>
                                    </div>
                                    <div class="small">
                                        <span class="me-2"><i class="bi bi-shield me-1"></i>AC {{ monster.ac }}</span>
                                        <span><i class="bi bi-heart me-1"></i>{{ monster.hp_max }} HP</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Cena de Combate (se step atual for combate) -->
            {% if current_step and current_step.tipo == 'combate' %}
            <div class="card bg-danger bg-opacity-25 border-danger mb-4 combat-bg">
                <div class="card-header border-danger">
                    <h5 class="mb-0"><i class="bi bi-shield-shaded me-2"></i>Cena de Combate</h5>
                </div>
                <div class="card-body text-center">
                    <p class="mb-3"><strong>{{ current_step.titulo }}</strong></p>
                    {% if quest and current_step.monstros %}
                    <p class="small text-light opacity-75 mb-3">
                        {{ current_step.monstros|length }} monstros vs {{ players|length }} jogadores
                    </p>
                    {% endif %}
                    <a href="{{ url_for('combat.session_tracker', session_id=game_session.id) }}" class="btn btn-danger w-100">
                        <i class="bi bi-play-circle me-1"></i>Abrir Rastreador de Combate
                    </a>
                </div>
            </div>
            {% endif %}

            <!-- Notas da Sessao -->
            <div class="card bg-dark border-info mb-4">
                <div class="card-header border-info d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-journal-text me-2"></i>Notas da Sess√£o
                    </h5>
                    <div>
                        <span class="text-muted small me-2" id="notes-save-status"></span>
                        <button class="btn btn-sm btn-success" onclick="saveNotes(false)">
                            <i class="bi bi-save me-1"></i>Guardar
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <textarea class="form-control bg-dark text-light border-secondary notes-textarea"
                              id="session-notes"
                              data-session-id="{{ game_session.id }}"
                              placeholder="Escreve aqui as tuas notas de sess√£o: NPCs encontrados, decis√µes dos jogadores, segredos descobertos, momentos memor√°veis...">{{ game_session.notas or '' }}</textarea>
                    <small class="text-muted d-block mt-2">
                        <i class="bi bi-info-circle me-1"></i>
                        As notas s√£o guardadas automaticamente enquanto escreves. Usa este espa√ßo para registar eventos importantes e lembretes para a pr√≥xima sess√£o.
                    </small>
                </div>
            </div>
        </div>

        <!-- Sidebar Direita - Tempo e Navega√ß√£o -->
        <div class="col-lg-3 mb-4">
            <!-- Tempo no Jogo -->
            <div class="card bg-dark border-info mb-4 sticky-top time-panel-bg" style="top: 20px;">
                <div class="card-header border-info">
                    <h5 class="mb-0"><i class="bi bi-clock me-2"></i>Tempo no Jogo</h5>
                </div>
                <div class="card-body">
                    <!-- Tempo no Jogo -->
                    <div class="mb-3">
                        <small class="text-muted d-block mb-1">
                            <i class="bi bi-sun me-1 text-info"></i>Hora Actual
                        </small>
                        <h5 class="mb-2" id="game-time">Dia 1, 08:00</h5>
                        <div id="game-time-controls"></div>
                    </div>

                    <hr class="border-secondary">

                    <!-- Descansos -->
                    <div>
                        <small class="text-muted d-block mb-2">
                            <i class="bi bi-moon-stars me-1"></i>Descansos
                        </small>
                        <div id="rest-controls"></div>
                    </div>
                </div>
            </div>

            <!-- Mapa da Aventura (Navega√ß√£o) -->
            {% if quest %}
            <div class="card bg-dark border-secondary quest-bg">
                <div class="card-header border-secondary">
                    <h6 class="mb-0"><i class="bi bi-map me-2"></i>Mapa da Aventura</h6>
                </div>
                <div class="list-group list-group-flush" style="max-height: 50vh; overflow-y: auto;">
                    {% for s in quest.passos %}
                    {% set is_current = s.id == game_session.passo_atual %}
                    {% set is_completed = s.id < game_session.passo_atual %}
                    <a href="{{ url_for('quest.step', quest_id=quest.id, step_id=s.id, session_id=game_session.id) }}"
                       class="list-group-item list-group-item-action bg-dark text-light border-secondary py-2 {% if is_current %}active border-danger{% endif %}">
                        <div class="d-flex align-items-center">
                            <span class="me-2">
                                {% if s.tipo == 'combate' %}
                                <i class="bi bi-shield-shaded text-danger"></i>
                                {% elif s.tipo == 'puzzle' %}
                                <i class="bi bi-puzzle text-warning"></i>
                                {% elif s.tipo == 'social' %}
                                <i class="bi bi-chat-dots text-info"></i>
                                {% else %}
                                <i class="bi bi-book text-secondary"></i>
                                {% endif %}
                            </span>
                            <div class="flex-grow-1">
                                <small {% if is_completed %}class="text-muted text-decoration-line-through"{% endif %}>
                                    {{ s.titulo[:25] }}{% if s.titulo|length > 25 %}...{% endif %}
                                </small>
                            </div>
                            {% if is_current %}
                            <span class="badge bg-danger"><i class="bi bi-geo-alt-fill"></i></span>
                            {% elif is_completed %}
                            <span class="badge bg-success"><i class="bi bi-check"></i></span>
                            {% else %}
                            <span class="badge bg-secondary">{{ s.id }}</span>
                            {% endif %}
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal: Selecionar Aventura -->
<div class="modal fade" id="questModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title"><i class="bi bi-map me-2"></i>Selecionar Aventura</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('session.set_quest', session_id=game_session.id) }}" method="post">
                <div class="modal-body">
                    <p class="text-muted mb-3">Para selecionar uma aventura, vai a pagina de Aventuras:</p>
                    <a href="{{ url_for('quest.list_quests') }}" class="btn btn-danger">
                        <i class="bi bi-map me-2"></i>Ver Aventuras Disponiveis
                    </a>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal: Adicionar Jogador -->
<div class="modal fade" id="addPlayerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title"><i class="bi bi-person-plus me-2"></i>Adicionar Jogador</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('session.add_player', session_id=game_session.id) }}" method="post">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="nome_jogador" class="form-label">Nome do Jogador</label>
                        <input type="text" class="form-control bg-dark text-light border-secondary"
                               id="nome_jogador" name="nome_jogador" placeholder="Nome real do jogador" required>
                    </div>

                    <hr class="border-secondary">
                    <h6 class="mb-3">Escolher Personagem Pre-Criado</h6>

                    <div class="row g-2 mb-3">
                        {% for template in templates %}
                        <div class="col-md-4">
                            <label class="template-mini card bg-secondary h-100" style="cursor: pointer;">
                                <input type="radio" name="template_id" value="{{ template.id }}" class="d-none">
                                <div class="card-body py-2 px-2">
                                    <strong class="d-block small">{{ template.nome }}</strong>
                                    <small class="text-muted">{{ template.classe }} - {{ template.raca }}</small>
                                    <div class="mt-1">
                                        <span class="badge bg-dark" style="font-size: 0.65rem;">HP {{ template.hp_max }}</span>
                                        <span class="badge bg-dark" style="font-size: 0.65rem;">AC {{ template.ac }}</span>
                                    </div>
                                </div>
                            </label>
                        </div>
                        {% endfor %}
                    </div>

                    {% if saved_characters %}
                    <hr class="border-secondary">
                    <h6 class="mb-3">Ou Personagem Guardado</h6>
                    <div class="row g-2">
                        {% for char in saved_characters %}
                        <div class="col-md-4">
                            <label class="template-mini card bg-secondary h-100" style="cursor: pointer;">
                                <input type="radio" name="saved_id" value="{{ char.id }}" class="d-none">
                                <div class="card-body py-2 px-2">
                                    <strong class="d-block small">{{ char.nome }}</strong>
                                    <small class="text-muted">{{ char.classe }} {{ char.nivel }}</small>
                                </div>
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-plus-circle me-1"></i>Adicionar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal: Level Up -->
<div class="modal fade" id="levelUpModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-light border-warning">
            <div class="modal-header border-warning bg-warning bg-opacity-10">
                <h5 class="modal-title text-warning">
                    <i class="bi bi-star-fill me-2"></i>
                    Level Up!
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-4">
                <h2 class="display-3 mb-3">üéâ</h2>
                <h4 id="levelup-player-name" class="mb-2"></h4>
                <p class="lead">
                    subiu para n√≠vel <span id="levelup-new-level" class="text-warning fw-bold"></span>!
                </p>
                <p class="text-muted">
                    Parab√©ns ao jogador! Actualiza a ficha de personagem com as melhorias do novo n√≠vel.
                </p>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-success" data-bs-dismiss="modal">
                    <i class="bi bi-check-circle me-1"></i>Continuar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/time-tracker.js') }}"></script>
<script src="{{ url_for('static', filename='js/session-notes.js') }}"></script>
<script>
// Definir session ID global para uso pelos scripts
window.sessionId = {{ game_session.id }};

// Highlight selected template/quest cards
document.querySelectorAll('.template-mini, #questModal .card').forEach(card => {
    card.addEventListener('click', function() {
        const parent = this.closest('.row');
        parent.querySelectorAll('.card').forEach(c => {
            c.style.borderColor = 'transparent';
        });
        this.style.borderColor = '#28a745';
    });
});

// Inicializar TimeTracker
const timeTracker = new TimeTracker({{ game_session.id }}, {
    autoUpdate: true,
    updateInterval: 5000,  // Update a cada 5 segundos (s√≥ tempo no jogo)
    onUpdate: (data) => {
        console.log('Tempo actualizado:', data);
    },
    onError: (error) => {
        console.error('Erro no tracker de tempo:', error);
    }
});

// Configurar elementos DOM
timeTracker.setElements({
    gameTime: 'game-time'
});

// Criar controles com TimeControlsBuilder
const controls = new TimeControlsBuilder(timeTracker);
controls.createGameTimeButtons('game-time-controls');
controls.createRestButtons('rest-controls');

// Fazer update inicial
timeTracker.update();
</script>
{% endblock %}
