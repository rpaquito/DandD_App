{% extends "base.html" %}

{% block title %}Rastreador de Combate{% endblock %}

{% block extra_css %}
<style>
    .participant-card {
        transition: all 0.3s ease;
    }
    .participant-card.active-turn {
        border-color: #ffc107 !important;
        box-shadow: 0 0 15px rgba(255, 193, 7, 0.3);
    }
    .hp-bar {
        height: 8px;
        transition: width 0.3s ease;
    }
    .condition-badge {
        cursor: pointer;
        transition: opacity 0.2s;
    }
    .condition-badge:hover {
        opacity: 0.8;
    }
    .drag-handle {
        cursor: grab;
    }
    .drag-handle:active {
        cursor: grabbing;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Barra de Sessao (se activa) -->
    {% if game_session %}
    <div class="alert alert-success bg-opacity-25 border-success mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div class="text-light">
                <i class="bi bi-controller me-2"></i>
                <strong>Sessao:</strong> {{ game_session.nome }}
                {% if session_combat and session_combat.quest_step_id %}
                <span class="badge bg-info ms-2">Passo {{ session_combat.quest_step_id }}</span>
                {% endif %}
            </div>
            <div>
                <a href="{{ url_for('session.dashboard', session_id=game_session.id) }}" class="btn btn-sm btn-outline-light me-2">
                    <i class="bi bi-speedometer2 me-1"></i>Painel
                </a>
                <form action="{{ url_for('combat.end_session_combat', session_id=game_session.id) }}" method="POST" class="d-inline">
                    <button type="submit" class="btn btn-sm btn-success">
                        <i class="bi bi-check-circle me-1"></i>Terminar Combate
                    </button>
                </form>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="row">
        <!-- Sidebar Esquerda - Ferramentas Rápidas -->
        <div class="col-lg-2 mb-4">
            <!-- Condições Rápidas -->
            <div class="card bg-dark border-secondary mb-4">
                <div class="card-header border-secondary">
                    <h6 class="mb-0"><i class="bi bi-exclamation-triangle me-2"></i>Condições 5e</h6>
                </div>
                <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                    <div class="d-grid gap-1">
                        {% for cond_id, cond in conditions.items() %}
                        <button class="btn btn-sm btn-outline-secondary text-start condition-ref"
                                data-bs-toggle="tooltip" title="{{ cond.descricao }}" style="font-size: 0.7rem;">
                            <i class="{{ cond.icone }} me-1"></i>{{ cond.nome }}
                        </button>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Calculadora de Dano Rápida -->
            <div class="card bg-dark border-secondary mb-4">
                <div class="card-header border-secondary">
                    <h6 class="mb-0"><i class="bi bi-calculator me-2"></i>Calculadora</h6>
                </div>
                <div class="card-body">
                    <div class="input-group input-group-sm mb-2">
                        <input type="text" class="form-control bg-dark text-light border-secondary"
                               id="diceExpression" placeholder="2d6+3" style="font-size: 0.75rem;">
                        <button class="btn btn-danger btn-sm" onclick="rollDice()">
                            <i class="bi bi-dice-5"></i>
                        </button>
                    </div>
                    <div id="diceCalcResult" class="text-center fs-5 text-warning"></div>
                </div>
            </div>

            <!-- Referência Rápida -->
            <div class="card bg-dark border-secondary mb-4">
                <div class="card-header border-secondary">
                    <h6 class="mb-0"><i class="bi bi-book me-2"></i>Referência</h6>
                </div>
                <div class="card-body" style="font-size: 0.7rem; max-height: 300px; overflow-y: auto;">
                    <p class="mb-1"><strong>Ações:</strong></p>
                    <ul class="mb-2" style="font-size: 0.65rem;">
                        <li>Atacar</li>
                        <li>Lançar Magia</li>
                        <li>Desengajar</li>
                        <li>Esquivar</li>
                        <li>Ajudar</li>
                        <li>Esconder</li>
                        <li>Preparar</li>
                    </ul>
                    <p class="mb-1"><strong>Cobertura:</strong></p>
                    <ul class="mb-0" style="font-size: 0.65rem;">
                        <li>Meia: +2 AC/DES</li>
                        <li>3/4: +5 AC/DES</li>
                        <li>Total: imune</li>
                    </ul>
                </div>
            </div>

            <!-- CDs Comuns -->
            <div class="card bg-dark border-info">
                <div class="card-header border-info">
                    <h6 class="mb-0"><i class="bi bi-bullseye me-2"></i>CDs</h6>
                </div>
                <div class="card-body" style="font-size: 0.7rem;">
                    <table class="table table-sm table-dark mb-0" style="font-size: 0.7rem;">
                        <tbody>
                            <tr><td>Muito Fácil</td><td class="text-end"><strong>5</strong></td></tr>
                            <tr><td>Fácil</td><td class="text-end"><strong>10</strong></td></tr>
                            <tr><td>Médio</td><td class="text-end"><strong>15</strong></td></tr>
                            <tr><td>Difícil</td><td class="text-end"><strong>20</strong></td></tr>
                            <tr><td>Muito Difícil</td><td class="text-end"><strong>25</strong></td></tr>
                            <tr><td>Impossível</td><td class="text-end"><strong>30</strong></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Painel Central - Combate e Mapa -->
        <div class="col-lg-7">
            <div class="card bg-dark border-danger mb-4 combat-bg">
                <div class="card-header border-danger d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="bi bi-shield-shaded me-2"></i>Rastreador de Combate
                    </h4>
                    <div>
                        <span class="badge bg-secondary me-2" id="roundCounter">Ronda: {{ session_combat.ronda_atual if session_combat else 1 }}</span>
                        <button class="btn btn-sm btn-outline-warning" onclick="nextTurn()">
                            <i class="bi bi-skip-forward me-1"></i>Próximo Turno
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Lista de Iniciativa -->
                    <div id="initiativeList" class="mb-4">
                        <div class="text-center text-light opacity-75 py-4" id="emptyMessage">
                            <i class="bi bi-people display-4 mb-3 d-block"></i>
                            <p>Adiciona participantes para começar o combate</p>
                        </div>
                    </div>

                    <!-- Controlos de Combate -->
                    <div class="d-flex gap-2 flex-wrap">
                        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addParticipantModal">
                            <i class="bi bi-plus-circle me-1"></i>Adicionar Participante
                        </button>
                        <button class="btn btn-outline-secondary" onclick="sortByInitiative()">
                            <i class="bi bi-sort-numeric-down me-1"></i>Ordenar por Iniciativa
                        </button>
                        <button class="btn btn-outline-danger" onclick="clearCombat()">
                            <i class="bi bi-trash me-1"></i>Limpar Combate
                        </button>
                    </div>
                </div>
            </div>

            <!-- Mapa Tactico (se configurado no step da sessao) -->
            {% if session_combat and session_combat.quest_step_id and current_step and current_step.mapa_tatico %}
            <div class="card bg-dark border-warning mb-4 tactical-map-bg">
                <div class="card-header border-warning d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-map me-2"></i>Mapa Tactico</h5>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-success active" id="toggle-players" onclick="toggleEntityFilter('showPlayers')">
                            <i class="bi bi-person-fill"></i> Jogadores
                        </button>
                        <button type="button" class="btn btn-outline-info active" id="toggle-npcs" onclick="toggleEntityFilter('showNPCs')">
                            <i class="bi bi-people"></i> NPCs
                        </button>
                        <button type="button" class="btn btn-outline-danger active" id="toggle-monsters" onclick="toggleEntityFilter('showMonsters')">
                            <i class="bi bi-bug-fill"></i> Monstros
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div style="overflow-x: auto; text-align: center;">
                        <canvas id="tacticalMap" style="border: 2px solid #666; border-radius: 4px;"></canvas>
                    </div>
                    <small class="text-muted d-block mt-2 text-center">
                        <i class="bi bi-info-circle me-1"></i>
                        Arrasta entidades para mover. Cada quadrado = {{ current_step.mapa_tatico.metros_por_quadrado }}m ({{ (current_step.mapa_tatico.metros_por_quadrado / 1.5 * 5)|int }} pes)
                    </small>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar Direita - Tempo e Dicas -->
        <div class="col-lg-3 mb-4">
            <!-- Gestão de Tempo e Estado da Sessão -->
            {% if game_session %}
            <div class="card bg-dark border-info no-print time-panel-bg mb-4 sticky-top" style="top: 20px;">
                <div class="card-header border-info">
                    <h6 class="mb-0"><i class="bi bi-clock me-2"></i>Gestão de Tempo</h6>
                </div>
                <div class="card-body">
                    <!-- Tempo de Sessão -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="text-muted">
                                <i class="bi bi-stopwatch me-1"></i>Duração
                            </small>
                            <div id="session-controls"></div>
                        </div>
                        <h6 class="mb-0" id="session-duration">0h 0m</h6>
                    </div>

                    <hr class="border-secondary">

                    <!-- Tempo de Combate -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small class="text-muted">
                                <i class="bi bi-shield-shaded me-1 text-danger"></i>Combate
                            </small>
                            <div id="combat-controls"></div>
                        </div>
                        <p class="mb-0 small" id="combat-time">-</p>
                    </div>

                    <!-- Turnos de Exploração -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small class="text-muted">
                                <i class="bi bi-compass me-1 text-warning"></i>Exploração
                            </small>
                            <p class="mb-0 small" id="exploration-turns">0</p>
                        </div>
                        <div id="exploration-controls"></div>
                    </div>

                    <hr class="border-secondary">

                    <!-- Tempo no Jogo -->
                    <div>
                        <small class="text-muted d-block mb-1">
                            <i class="bi bi-sun me-1 text-info"></i>Tempo no Jogo
                        </small>
                        <h6 class="mb-2" id="game-time">Dia 1, 08:00</h6>
                        <div id="game-time-controls" class="mb-2"></div>
                        <div id="rest-controls"></div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Calculadora de XP -->
            <div class="card bg-dark border-success mb-4">
                <div class="card-header border-success">
                    <h6 class="mb-0">
                        <i class="bi bi-star me-2"></i>Calculadora de XP
                    </h6>
                </div>
                <div class="card-body">
                    <p class="small text-muted mb-2">Monstros derrotados neste combate</p>

                    <!-- Lista de monstros -->
                    <div id="xp-monsters-list" class="mb-3" style="max-height: 200px; overflow-y: auto;">
                        <p class="text-muted small mb-0">Sem monstros derrotados</p>
                    </div>

                    <!-- Resumo de XP -->
                    <div class="bg-secondary rounded p-2 mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <strong class="small">Total XP:</strong>
                            <span class="badge bg-warning text-dark" id="xp-total">0</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <strong class="small">Por Jogador:</strong>
                            <span class="badge bg-success" id="xp-per-player">0</span>
                        </div>
                    </div>

                    <!-- Botões -->
                    <div class="d-grid gap-2">
                        <button class="btn btn-sm btn-success" onclick="awardXPToParty()">
                            <i class="bi bi-trophy me-1"></i>Atribuir XP ao Grupo
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearXPCalculator()">
                            <i class="bi bi-x-circle me-1"></i>Limpar
                        </button>
                    </div>

                    <small class="text-muted d-block mt-2">
                        <i class="bi bi-info-circle me-1"></i>
                        Os monstros derrotados (HP = 0) são adicionados automaticamente.
                    </small>
                </div>
            </div>

            <!-- Combat Log -->
            <div class="card bg-dark border-primary mb-4">
                <div class="card-header border-primary d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="bi bi-journal-text me-2"></i>Histórico de Combate
                    </h6>
                    <button class="btn btn-sm btn-outline-danger" onclick="clearCombatLogUI()" title="Limpar histórico">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                <div class="card-body p-2">
                    <div id="combat-log-container" style="max-height: 300px; overflow-y: auto; font-size: 0.75rem;">
                        <p class="text-muted small mb-0 text-center py-3">Sem ações registadas</p>
                    </div>
                </div>
            </div>

            <!-- Dicas do Mestre para Combate -->
            <div class="card bg-dark border-warning mb-4">
                <div class="card-header border-warning bg-warning bg-opacity-10">
                    <h5 class="mb-0 text-warning"><i class="bi bi-lightbulb me-2"></i>Dicas de Mestre</h5>
                </div>
                <div class="card-body small">
                    <div class="accordion accordion-flush" id="dmTipsAccordion">
                        <!-- Descrever Ataques -->
                        <div class="accordion-item bg-transparent border-secondary">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed bg-dark text-light" type="button" data-bs-toggle="collapse" data-bs-target="#attackDescriptions">
                                    <i class="bi bi-chat-quote me-2"></i>Descrever Ataques
                                </button>
                            </h2>
                            <div id="attackDescriptions" class="accordion-collapse collapse" data-bs-parent="#dmTipsAccordion">
                                <div class="accordion-body bg-dark">
                                    <p class="text-success"><strong>Acerto:</strong></p>
                                    <ul class="mb-2">
                                        <li>"A lâmina corta o ar e atinge o flanco!"</li>
                                        <li>"O golpe encontra uma fresta na armadura!"</li>
                                        <li>"A magia explode contra o alvo!"</li>
                                    </ul>
                                    <p class="text-danger"><strong>Falha:</strong></p>
                                    <ul class="mb-2">
                                        <li>"O inimigo esquiva-se no último segundo!"</li>
                                        <li>"A espada ressoa contra o escudo!"</li>
                                        <li>"O feitiço dissipa-se inofensivamente!"</li>
                                    </ul>
                                    <p class="text-warning"><strong>Crítico (20):</strong></p>
                                    <ul class="mb-0">
                                        <li>"Um golpe devastador atinge em cheio!"</li>
                                        <li>"Encontras o ponto fraco perfeito!"</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Táticas de Monstros -->
                        <div class="accordion-item bg-transparent border-secondary">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed bg-dark text-light" type="button" data-bs-toggle="collapse" data-bs-target="#monsterTactics">
                                    <i class="bi bi-bug me-2"></i>Táticas de Monstros
                                </button>
                            </h2>
                            <div id="monsterTactics" class="accordion-collapse collapse" data-bs-parent="#dmTipsAccordion">
                                <div class="accordion-body bg-dark">
                                    <p><strong>Esqueletos:</strong> Atacam o mais próximo, sem medo</p>
                                    <p><strong>Zombies:</strong> Vão sempre ao mesmo alvo, lentos</p>
                                    <p><strong>Goblins:</strong> Táticas de grupo, fogem se perderem líder</p>
                                    <p><strong>Lobos:</strong> Atacam em matilha, usam vantagem</p>
                                    <p class="mb-0"><strong>Boss:</strong> Foca nos curadores primeiro, usa terreno</p>
                                </div>
                            </div>
                        </div>

                        <!-- Situações Comuns -->
                        <div class="accordion-item bg-transparent border-secondary">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed bg-dark text-light" type="button" data-bs-toggle="collapse" data-bs-target="#commonSituations">
                                    <i class="bi bi-question-circle me-2"></i>Situações Comuns
                                </button>
                            </h2>
                            <div id="commonSituations" class="accordion-collapse collapse" data-bs-parent="#dmTipsAccordion">
                                <div class="accordion-body bg-dark">
                                    <p><strong>Empurrar:</strong> Atletismo vs Atletismo/Acrobacia</p>
                                    <p><strong>Agarrar:</strong> Atletismo vs Atletismo/Acrobacia</p>
                                    <p class="mb-0"><strong>Desarmar:</strong> Ataque vs Atletismo/Acrobacia</p>
                                </div>
                            </div>
                        </div>

                        <!-- Ajustar Dificuldade -->
                        <div class="accordion-item bg-transparent border-secondary">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed bg-dark text-light" type="button" data-bs-toggle="collapse" data-bs-target="#adjustDifficulty">
                                    <i class="bi bi-sliders me-2"></i>Ajustar Dificuldade
                                </button>
                            </h2>
                            <div id="adjustDifficulty" class="accordion-collapse collapse" data-bs-parent="#dmTipsAccordion">
                                <div class="accordion-body bg-dark">
                                    <p class="text-success"><strong>Muito Fácil?</strong></p>
                                    <ul class="mb-2">
                                        <li>Adiciona reforços</li>
                                        <li>Aumenta HP dos monstros</li>
                                        <li>Monstros usam táticas melhores</li>
                                    </ul>
                                    <p class="text-danger"><strong>Muito Difícil?</strong></p>
                                    <ul class="mb-0">
                                        <li>Monstros falham mais ataques</li>
                                        <li>Reduz HP secretamente</li>
                                        <li>Aliados aparecem para ajudar</li>
                                        <li>Inimigos fogem mais cedo</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Adicionar Participante -->
<div class="modal fade" id="addParticipantModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title"><i class="bi bi-person-plus me-2"></i>Adicionar Participante</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addParticipantForm">
                    <div class="mb-3">
                        <label class="form-label">Nome</label>
                        <input type="text" class="form-control bg-dark text-light border-secondary"
                               id="participantName" required>
                    </div>
                    <div class="row mb-3">
                        <div class="col-4">
                            <label class="form-label">Iniciativa</label>
                            <input type="number" class="form-control bg-dark text-light border-secondary"
                                   id="participantInit" value="10">
                        </div>
                        <div class="col-4">
                            <label class="form-label">HP Máx</label>
                            <input type="number" class="form-control bg-dark text-light border-secondary"
                                   id="participantHP" value="10">
                        </div>
                        <div class="col-4">
                            <label class="form-label">AC</label>
                            <input type="number" class="form-control bg-dark text-light border-secondary"
                                   id="participantAC" value="10">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tipo</label>
                        <select class="form-select bg-dark text-light border-secondary" id="participantType">
                            <option value="jogador">Jogador</option>
                            <option value="monstro" selected>Monstro</option>
                            <option value="npc">NPC</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="addParticipant()">
                    <i class="bi bi-plus-circle me-1"></i>Adicionar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Dano/Cura -->
<div class="modal fade" id="damageModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="damageModalTitle">Dano/Cura</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="damageTargetId">
                <div class="input-group">
                    <input type="number" class="form-control bg-dark text-light border-secondary fs-4 text-center"
                           id="damageAmount" value="0">
                </div>
                <div class="d-grid gap-2 mt-3">
                    <button class="btn btn-danger" onclick="applyDamage(false)">
                        <i class="bi bi-dash-circle me-1"></i>Aplicar Dano
                    </button>
                    <button class="btn btn-success" onclick="applyDamage(true)">
                        <i class="bi bi-plus-circle me-1"></i>Curar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Attack Roll -->
<div class="modal fade" id="attackRollModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-danger">
                <h5 class="modal-title">
                    <i class="bi bi-crosshair me-2"></i>Attack Roll
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="attackActorId">
                <input type="hidden" id="attackActorNome">

                <div class="mb-3">
                    <label class="form-label">Alvo</label>
                    <select class="form-select bg-dark text-light border-secondary" id="attackTargetId">
                        <option value="">Selecionar alvo...</option>
                    </select>
                </div>

                <div class="row mb-3">
                    <div class="col-6">
                        <label class="form-label">Bónus de Ataque</label>
                        <input type="number" class="form-control bg-dark text-light border-secondary"
                               id="attackBonus" value="0">
                    </div>
                    <div class="col-6">
                        <label class="form-label">AC do Alvo</label>
                        <input type="number" class="form-control bg-dark text-light border-secondary"
                               id="attackTargetAC" value="10" readonly>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="attackAdvantage">
                        <label class="form-check-label">Vantagem</label>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="attackDisadvantage">
                        <label class="form-check-label">Desvantagem</label>
                    </div>
                </div>

                <div id="attackResult" class="alert alert-secondary d-none"></div>

                <div class="d-grid gap-2">
                    <button class="btn btn-danger" onclick="performAttackRoll()">
                        <i class="bi bi-dice-5 me-1"></i>Rolar Ataque (d20)
                    </button>
                    <button class="btn btn-success d-none" id="attackDamageButton" onclick="goToDamageFromAttack()">
                        <i class="bi bi-arrow-right me-1"></i>Aplicar Dano
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Damage Roll Avançado -->
<div class="modal fade" id="damageRollModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-danger">
                <h5 class="modal-title">
                    <i class="bi bi-heart-fill me-2 text-danger"></i>Damage Roll
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="damageActorId">
                <input type="hidden" id="damageActorNome">
                <input type="hidden" id="damageRollTargetId">
                <input type="hidden" id="damageRollTargetNome">

                <div class="mb-3">
                    <label class="form-label">Expressão de Dados</label>
                    <input type="text" class="form-control bg-dark text-light border-secondary"
                           id="damageExpression" placeholder="2d6+3" value="1d6">
                </div>

                <div class="mb-3">
                    <label class="form-label">Tipo de Dano</label>
                    <select class="form-select bg-dark text-light border-secondary" id="damageType">
                        <option value="slashing">Cortante</option>
                        <option value="piercing">Perfurante</option>
                        <option value="bludgeoning">Contundente</option>
                        <option value="fire">Fogo</option>
                        <option value="cold">Gelo</option>
                        <option value="lightning">Elétrico</option>
                        <option value="acid">Ácido</option>
                        <option value="poison">Veneno</option>
                        <option value="psychic">Psíquico</option>
                        <option value="necrotic">Necrótico</option>
                        <option value="radiant">Radiante</option>
                        <option value="thunder">Trovão</option>
                    </select>
                </div>

                <div class="mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="damageCrit">
                        <label class="form-check-label">Crítico (dobra dados)</label>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="damageResistance">
                        <label class="form-check-label">Resistência (metade)</label>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="damageImmunity">
                        <label class="form-check-label">Imunidade (0)</label>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="damageVulnerability">
                        <label class="form-check-label">Vulnerabilidade (dobro)</label>
                    </div>
                </div>

                <div id="damageRollResult" class="alert alert-secondary d-none"></div>

                <div class="d-grid gap-2">
                    <button class="btn btn-danger" onclick="performDamageRoll()">
                        <i class="bi bi-dice-5 me-1"></i>Rolar Dano
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Spell Slots -->
<div class="modal fade" id="spellSlotsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-primary">
                <h5 class="modal-title">
                    <i class="bi bi-magic me-2"></i>Spell Slots
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="spellCasterNome">
                <input type="hidden" id="spellCasterId">
                <input type="hidden" id="spellParticipantId">

                <div class="mb-3">
                    <label class="form-label">Nome da Magia</label>
                    <input type="text" class="form-control bg-dark text-light border-secondary"
                           id="spellName" placeholder="Ex: Bola de Fogo">
                </div>

                <div class="mb-3">
                    <label class="form-label">Nível da Magia</label>
                    <select class="form-select bg-dark text-light border-secondary" id="spellLevel">
                        <option value="0">Truque (Cantrip)</option>
                        <option value="1">1º Nível</option>
                        <option value="2">2º Nível</option>
                        <option value="3">3º Nível</option>
                        <option value="4">4º Nível</option>
                        <option value="5">5º Nível</option>
                        <option value="6">6º Nível</option>
                        <option value="7">7º Nível</option>
                        <option value="8">8º Nível</option>
                        <option value="9">9º Nível</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Alvo (Opcional)</label>
                    <select class="form-select bg-dark text-light border-secondary" id="spellTargetId">
                        <option value="">Sem alvo específico</option>
                    </select>
                </div>

                <div id="spellSlotsDisplay" class="mb-3">
                    <p class="small text-muted">Spell Slots Disponíveis:</p>
                    <div id="spellSlotsGrid"></div>
                </div>

                <div id="spellResult" class="alert alert-secondary d-none"></div>

                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="castSpell()">
                        <i class="bi bi-stars me-1"></i>Lançar Magia
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/combat.js') }}"></script>
<script src="{{ url_for('static', filename='js/map-grid.js') }}"></script>
{% if game_session %}
<script src="{{ url_for('static', filename='js/time-tracker.js') }}"></script>
<script src="{{ url_for('static', filename='js/xp-calculator.js') }}"></script>
{% endif %}
<script>
    // Contexto de sessao
    {% if game_session %}
    window.sessionId = {{ game_session.id }};
    window.sessionMode = true;
    {% else %}
    window.sessionId = null;
    window.sessionMode = false;
    {% endif %}

    // Participantes iniciais da sessao
    {% if initial_participants %}
    window.initialParticipants = {{ initial_participants|tojson|safe }};
    {% else %}
    window.initialParticipants = null;
    {% endif %}

    // Inicializar tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Verificar parâmetros URL para adicionar automaticamente
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('add')) {
        document.getElementById('participantName').value = urlParams.get('add');
        document.getElementById('participantHP').value = urlParams.get('hp') || 10;
        document.getElementById('participantAC').value = urlParams.get('ac') || 10;
        new bootstrap.Modal(document.getElementById('addParticipantModal')).show();
    }

    // Carregar combate existente ou participantes iniciais
    if (window.initialParticipants && window.initialParticipants.length > 0) {
        loadSessionParticipants(window.initialParticipants);
    } else {
        loadCombat();
    }

    // ===== Inicializar Mapa Tactico (se disponivel) =====
    {% if session_combat and session_combat.quest_step_id and current_step and current_step.mapa_tatico %}
    // Inicializar mapa quando pagina carrega
    document.addEventListener('DOMContentLoaded', function() {
        window.mapGrid = new MapGrid('tacticalMap', {
            gridWidth: {{ current_step.mapa_tatico.grid_largura }},
            gridHeight: {{ current_step.mapa_tatico.grid_altura }},
            squareSizeMeters: {{ current_step.mapa_tatico.metros_por_quadrado }},
            cellSize: 40,
            backgroundImage: {% if current_step.mapa_tatico.imagem_fundo %}'{{ current_step.mapa_tatico.imagem_fundo }}'{% else %}null{% endif %}
        });

        // Carregar posicoes do servidor
        fetch('/mapa/sessao/{{ game_session.id }}/passo/{{ session_combat.quest_step_id }}/posicoes')
            .then(function(response) { return response.json(); })
            .then(function(data) {
                if (data.positions && data.positions.length > 0) {
                    window.mapGrid.loadEntities(data.positions);
                    enrichMapEntitiesWithCombatData();
                } else {
                    // Se nao houver posicoes, inicializar com posicoes padrao
                    inicializarMapaPadrao();
                }
            })
            .catch(function(error) {
                console.error('Erro ao carregar posicoes:', error);
                inicializarMapaPadrao();
            });

        // Callback: Sincronizar movimento ao servidor
        window.mapGrid.onEntityMoved = function(entity) {
            fetch('/mapa/sessao/{{ game_session.id }}/passo/{{ session_combat.quest_step_id }}/mover', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    entity_id: entity.entity_id,
                    x: entity.grid_x,
                    y: entity.grid_y
                })
            })
            .then(function(response) { return response.json(); })
            .then(function(data) {
                console.log('Posicao actualizada:', data);
            })
            .catch(function(error) {
                console.error('Erro ao actualizar posicao:', error);
            });
        };

        // Callback: Mostrar info da entidade
        window.mapGrid.onEntitySelected = function(entity) {
            console.log('Entidade seleccionada:', entity);
        };
    });

    // Funcao para inicializar mapa com posicoes padrao
    function inicializarMapaPadrao() {
        {% if current_step.mapa_tatico.posicoes_iniciais %}
        const initialPositions = {{ current_step.mapa_tatico.posicoes_iniciais|tojson }};

        fetch('/mapa/sessao/{{ game_session.id }}/passo/{{ session_combat.quest_step_id }}/inicializar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                map_config: {
                    grid_largura: {{ current_step.mapa_tatico.grid_largura }},
                    grid_altura: {{ current_step.mapa_tatico.grid_altura }},
                    metros_por_quadrado: {{ current_step.mapa_tatico.metros_por_quadrado }},
                    imagem_fundo: {% if current_step.mapa_tatico.imagem_fundo %}'{{ current_step.mapa_tatico.imagem_fundo }}'{% else %}null{% endif %}
                },
                initial_positions: initialPositions
            })
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            console.log('Mapa inicializado:', data);
            if (data.positions) {
                window.mapGrid.loadEntities(data.positions);
            }
        })
        .catch(function(error) {
            console.error('Erro ao inicializar mapa:', error);
        });
        {% endif %}
    }

    // Toggle de filtros de entidades
    function toggleEntityFilter(filterName) {
        if (window.mapGrid) {
            const currentValue = window.mapGrid.filters[filterName];
            window.mapGrid.setFilter(filterName, !currentValue);

            // Atualizar estado visual dos botoes
            const buttonId = 'toggle-' + filterName.replace('show', '').toLowerCase();
            const button = document.getElementById(buttonId);
            if (button) {
                if (window.mapGrid.filters[filterName]) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            }
        }
    }

    // Enriquecer entidades do mapa com dados de combate
    function enrichMapEntitiesWithCombatData() {
        if (!window.mapGrid || !window.combatState) return;

        window.mapGrid.entities.forEach(function(mapEntity) {
            // Procurar participante correspondente no combate
            const participant = window.combatState.participants.find(function(p) {
                return p.id === mapEntity.entity_id;
            });

            if (participant) {
                // Enriquecer com dados de combate
                mapEntity.nome = participant.nome;
                mapEntity.ac = participant.ac;
                mapEntity.hp_atual = participant.hp_atual;
                mapEntity.hp_max = participant.hp_max;
            }
        });

        window.mapGrid.render();
    }
    {% endif %}

    // ===== Inicializar TimeTracker =====
    {% if game_session %}
    // Inicializar TimeTracker
    const timeTracker = new TimeTracker({{ game_session.id }}, {
        autoUpdate: true,
        updateInterval: 1000,
        onError: (error) => {
            console.error('Erro no tracker de tempo:', error);
        }
    });

    // Configurar elementos DOM
    timeTracker.setElements({
        sessionDuration: 'session-duration',
        combatTime: 'combat-time',
        explorationTurns: 'exploration-turns',
        gameTime: 'game-time'
    });

    // Criar controles
    const controls = new TimeControlsBuilder(timeTracker);
    controls.createStartPauseButton('session-controls');
    controls.createCombatRoundButton('combat-controls');
    controls.createExplorationButton('exploration-controls');
    controls.createGameTimeButtons('game-time-controls');
    controls.createRestButtons('rest-controls');

    // Fazer update inicial
    timeTracker.update();

    // ===== Inicializar XP Calculator =====
    // Contar jogadores no combate
    const partySize = combatState.participants.filter(p => p.tipo === 'jogador').length;

    // Inicializar XP Calculator
    initXPCalculator({{ game_session.id }}, partySize);

    console.log('XP Calculator inicializado com', partySize, 'jogadores');
    {% endif %}
</script>
{% endblock %}
