{% extends "base.html" %}

{% block title %}{{ step.titulo }} - {{ quest.titulo }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Barra de Sessao (se activa) -->
    {% if game_session %}
    <div class="alert alert-success bg-opacity-25 border-success mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div class="text-light">
                <i class="bi bi-controller me-2"></i>
                <strong>Sessao:</strong> {{ game_session.nome }}
                <span class="badge bg-success ms-2">{{ players|length }} jogadores</span>
            </div>
            <div>
                <a href="{{ url_for('session.dashboard', session_id=game_session.id) }}" class="btn btn-sm btn-success me-2">
                    <i class="bi bi-speedometer2 me-1"></i>Painel da Sessao
                </a>
                <a href="{{ url_for('print.map_view', quest_id=quest.id) }}" class="btn btn-sm btn-info" target="_blank">
                    <i class="bi bi-map me-1"></i>Mapa da Aventura
                </a>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="row">
        <!-- Sidebar Esquerda - Jogadores, NPCs e Monstros -->
        {% if game_session and players %}
        <div class="col-lg-2 mb-4">
            <!-- Party Panel -->
            <div class="card bg-dark border-success sticky-top mb-4" style="top: 20px;">
                <div class="card-header border-success d-flex justify-content-between align-items-center">
                    <small class="text-success"><i class="bi bi-people me-1"></i>Party</small>
                    <small class="badge bg-success">{{ players|length }}</small>
                </div>
                <div class="list-group list-group-flush" style="max-height: 40vh; overflow-y: auto;">
                    {% for player in players %}
                    {% set char = player.get_character_data() %}
                    <div class="list-group-item bg-dark text-light border-secondary py-2" id="player-{{ player.id }}">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small class="fw-bold text-truncate" style="max-width: 80px;">{{ char.get('nome', player.nome_jogador) }}</small>
                            <small class="text-light opacity-75">AC {{ char.get('ac', 10) }}</small>
                        </div>

                        <!-- HP Bar -->
                        {% set hp_percent = (player.hp_atual / player.hp_max * 100)|int %}
                        <div class="progress mb-1" style="height: 6px;">
                            <div class="progress-bar bg-{% if hp_percent > 50 %}success{% elif hp_percent > 25 %}warning{% else %}danger{% endif %}"
                                 style="width: {{ hp_percent }}%"></div>
                        </div>

                        <!-- HP Controls -->
                        <div class="d-flex align-items-center justify-content-between">
                            <button class="btn btn-outline-danger btn-sm px-1 py-0" style="font-size: 0.7rem;" onclick="updateHp({{ player.id }}, 'damage', 1)">
                                <i class="bi bi-dash"></i>
                            </button>
                            <span class="hp-display badge {% if hp_percent > 50 %}bg-success{% elif hp_percent > 25 %}bg-warning{% else %}bg-danger{% endif %}" id="hp-{{ player.id }}">
                                {{ player.hp_atual }}/{{ player.hp_max }}
                            </span>
                            <button class="btn btn-outline-success btn-sm px-1 py-0" style="font-size: 0.7rem;" onclick="updateHp({{ player.id }}, 'heal', 1)">
                                <i class="bi bi-plus"></i>
                            </button>
                        </div>

                        <!-- Condicoes -->
                        {% if player.get_condicoes() %}
                        <div class="mt-1">
                            {% for cond in player.get_condicoes() %}
                            {% set cond_data = CONDICOES_5E.get(cond.lower().replace(' ', '_').replace('ç', 'c').replace('ã', 'a'), {}) %}
                            <span class="condition-badge-with-icon" title="{{ cond_data.get('descricao', '') }}">
                                {% if cond_data.get('imagem') %}
                                <img src="{{ cond_data.imagem }}" alt="{{ cond }}">
                                {% else %}
                                <i class="{{ cond_data.get('icone', 'bi-exclamation-circle') }}"></i>
                                {% endif %}
                                <span style="font-size: 0.7em;">{{ cond }}</span>
                            </span>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>

                <!-- Botao Combate Rapido -->
                {% if step.tipo == 'combate' %}
                <div class="card-footer border-success p-2">
                    <form action="{{ url_for('quest.start_step_combat', quest_id=quest.id, step_id=step_id) }}" method="POST">
                        <input type="hidden" name="session_id" value="{{ game_session.id }}">
                        <button type="submit" class="btn btn-danger btn-sm w-100">
                            <i class="bi bi-shield-shaded me-1"></i>Combate!
                        </button>
                    </form>
                </div>
                {% endif %}
            </div>

            <!-- NPCs Presentes -->
            {% set npcs_presentes = quest.get_npcs_for_step(step) %}
            {% if npcs_presentes %}
            <div class="card bg-dark border-secondary mb-4">
                <div class="card-header border-secondary">
                    <h6 class="mb-0"><i class="bi bi-people me-2"></i>NPCs</h6>
                </div>
                <div class="list-group list-group-flush" style="max-height: 30vh; overflow-y: auto;">
                    {% for npc in npcs_presentes %}
                    <div class="list-group-item bg-dark text-light border-secondary">
                        <h6 class="mb-1 small">{{ npc.nome }}</h6>
                        <small class="text-light opacity-75" style="font-size: 0.7rem;">{{ npc.descricao[:60] }}{% if npc.descricao|length > 60 %}...{% endif %}</small>
                        {% if npc.dialogos %}
                        <button class="btn btn-sm btn-outline-info mt-2 w-100" style="font-size: 0.7rem;" data-bs-toggle="collapse" data-bs-target="#dialogos-{{ npc.id }}">
                            <i class="bi bi-chat-quote me-1"></i>Diálogos
                        </button>
                        <div class="collapse mt-2" id="dialogos-{{ npc.id }}">
                            <ul class="list-unstyled" style="font-size: 0.7rem;">
                                {% for dialogo in npc.dialogos %}
                                <li class="mb-1 fst-italic">"{{ dialogo[:50] }}{% if dialogo|length > 50 %}...{% endif %}"</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Monstros no Passo -->
            {% set monstros_presentes = quest.get_monsters_for_step(step) %}
            {% if monstros_presentes %}
            <div class="card bg-dark border-danger mb-4">
                <div class="card-header border-danger">
                    <h6 class="mb-0"><i class="bi bi-bug me-2"></i>Monstros</h6>
                </div>
                <div class="list-group list-group-flush" style="max-height: 30vh; overflow-y: auto;">
                    {% for monster in monstros_presentes %}
                    <div class="list-group-item bg-dark text-light border-secondary">
                        <div class="d-flex justify-content-between">
                            <h6 class="mb-1 small">{{ monster.nome }}</h6>
                            <span class="badge bg-danger" style="font-size: 0.6rem;">CR {{ monster.cr }}</span>
                        </div>
                        <div style="font-size: 0.7rem;">
                            <span class="me-2"><i class="bi bi-shield me-1"></i>AC {{ monster.ac }}</span>
                            <span><i class="bi bi-heart me-1"></i>{{ monster.hp_max }} HP</span>
                        </div>
                        <button class="btn btn-sm btn-outline-danger mt-2 w-100" style="font-size: 0.7rem;" onclick="adicionarAoCombate('{{ monster.nome }}', {{ monster.hp_max }}, {{ monster.ac }})">
                            <i class="bi bi-plus-circle me-1"></i>Adicionar
                        </button>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Conteúdo Principal -->
        <div class="col-lg-{% if game_session and players %}7{% else %}9{% endif %}">
            <!-- Navegação de Passo -->
            <nav aria-label="breadcrumb" class="mb-3">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Início</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('quest.overview', quest_id=quest.id) }}">{{ quest.titulo }}</a></li>
                    <li class="breadcrumb-item active">Passo {{ step_id }}</li>
                </ol>
            </nav>

            <!-- Cabeçalho do Passo -->
            <div class="card bg-dark border-secondary mb-4">
                <div class="card-header border-secondary d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <span class="badge bg-danger me-2">{{ step_id }}</span>
                        {{ step.titulo }}
                    </h4>
                    <span class="badge bg-{% if step.tipo == 'combate' %}danger{% elif step.tipo == 'puzzle' %}warning{% elif step.tipo == 'social' %}info{% else %}secondary{% endif %}">
                        {% if step.tipo == 'combate' %}<i class="bi bi-shield-shaded me-1"></i>Combate
                        {% elif step.tipo == 'puzzle' %}<i class="bi bi-puzzle me-1"></i>Puzzle
                        {% elif step.tipo == 'social' %}<i class="bi bi-chat-dots me-1"></i>Social
                        {% else %}<i class="bi bi-book me-1"></i>Narrativa{% endif %}
                    </span>
                </div>
            </div>

            <!-- Texto para Ler aos Jogadores -->
            <div class="card bg-dark border-warning mb-4">
                <div class="card-header border-warning bg-warning bg-opacity-10">
                    <h5 class="mb-0 text-warning">
                        <i class="bi bi-megaphone me-2"></i>Ler aos Jogadores
                    </h5>
                </div>
                <div class="card-body">
                    <div class="player-text-enhanced fs-5" style="line-height: 1.8;">
                        {{ step.texto_jogadores|safe }}
                    </div>
                </div>
            </div>

            <!-- Divisor Ornamental -->
            <div class="ornamental-divider"></div>

            <!-- Notas do Mestre -->
            {% if step.notas_mestre %}
            <div class="card bg-dark border-info mb-4">
                <div class="card-header border-info bg-info bg-opacity-10">
                    <h5 class="mb-0 text-info">
                        <i class="bi bi-journal-text me-2"></i>Notas do Mestre
                        <small class="text-light opacity-75">(Só para ti)</small>
                    </h5>
                </div>
                <div class="card-body">
                    {{ step.notas_mestre|safe }}
                </div>
            </div>
            {% endif %}

            <!-- Dicas de Improvisação -->
            {% if step.dicas_improvisacao %}
            <div class="card bg-dark border-success mb-4">
                <div class="card-header border-success bg-success bg-opacity-10">
                    <h5 class="mb-0 text-success">
                        <i class="bi bi-lightbulb me-2"></i>Dicas de Improvisação
                    </h5>
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        {% for dica in step.dicas_improvisacao %}
                        <li class="mb-2">{{ dica }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}

            <!-- Link para Mapa Tactico (agora no Rastreador de Combate) -->
            {% if step.mapa_tatico and game_session %}
            <div class="alert alert-info mb-4">
                <i class="bi bi-map me-2"></i>
                <strong>Mapa Táctico disponível</strong>
                <p class="mb-2 small">Este passo tem um mapa tático configurado. Abre o Rastreador de Combate para ver o mapa.</p>
                <a href="{{ url_for('combat.session_tracker', session_id=game_session.id) }}" class="btn btn-sm btn-info" target="_blank">
                    <i class="bi bi-shield-shaded me-1"></i>Abrir Rastreador com Mapa
                </a>
            </div>
            {% endif %}

            <!-- Navegação entre Passos -->
            <div class="d-flex justify-content-between mt-4">
                {% if step_id > 1 %}
                <a href="{{ url_for('quest.step', quest_id=quest.id, step_id=step_id - 1, session_id=game_session.id if game_session else None) }}" class="btn btn-outline-light">
                    <i class="bi bi-arrow-left me-1"></i>Passo Anterior
                </a>
                {% else %}
                <span></span>
                {% endif %}

                {% if step.proximos_passos %}
                <div class="btn-group">
                    {% for next_id in step.proximos_passos %}
                    {% set next_step = quest.get_step(next_id) %}
                    <a href="{{ url_for('quest.step', quest_id=quest.id, step_id=next_id, session_id=game_session.id if game_session else None) }}" class="btn btn-danger">
                        {{ next_step.titulo if next_step else 'Passo ' + next_id|string }}
                        <i class="bi bi-arrow-right ms-1"></i>
                    </a>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Sidebar Direita - Tempo e Navegação -->
        <div class="col-lg-3 mb-4">
            <!-- Gestão de Tempo e Estado da Sessão -->
            {% if game_session %}
            <div class="card bg-dark border-info no-print time-panel-bg mb-4 sticky-top" style="top: 20px;">
                <div class="card-header border-info">
                    <h6 class="mb-0"><i class="bi bi-clock me-2"></i>Gestão de Tempo</h6>
                </div>
                <div class="card-body">
                    <!-- Tempo de Sessão -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="text-muted">
                                <i class="bi bi-stopwatch me-1"></i>Duração
                            </small>
                            <div id="session-controls"></div>
                        </div>
                        <h6 class="mb-0" id="session-duration">0h 0m</h6>
                    </div>

                    <hr class="border-secondary">

                    <!-- Tempo de Combate -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small class="text-muted">
                                <i class="bi bi-shield-shaded me-1 text-danger"></i>Combate
                            </small>
                            <div id="combat-controls"></div>
                        </div>
                        <p class="mb-0 small" id="combat-time">-</p>
                    </div>

                    <!-- Turnos de Exploração -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small class="text-muted">
                                <i class="bi bi-compass me-1 text-warning"></i>Exploração
                            </small>
                            <p class="mb-0 small" id="exploration-turns">0</p>
                        </div>
                        <div id="exploration-controls"></div>
                    </div>

                    <hr class="border-secondary">

                    <!-- Tempo no Jogo -->
                    <div>
                        <small class="text-muted d-block mb-1">
                            <i class="bi bi-sun me-1 text-info"></i>Tempo no Jogo
                        </small>
                        <h6 class="mb-2" id="game-time">Dia 1, 08:00</h6>
                        <div id="game-time-controls" class="mb-2"></div>
                        <div id="rest-controls"></div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Mapa da Aventura -->
            <div class="card bg-dark border-secondary quest-bg">
                <div class="card-header border-secondary">
                    <small><i class="bi bi-signpost-split me-1"></i>Mapa da Aventura</small>
                </div>
                <div class="list-group list-group-flush" style="max-height: 50vh; overflow-y: auto;">
                    {% for s in quest.passos %}
                    {% set is_current = s.id == step_id %}
                    {% set is_completed = s.id < step_id %}
                    <a href="{{ url_for('quest.step', quest_id=quest.id, step_id=s.id, session_id=game_session.id if game_session else None) }}"
                       class="list-group-item list-group-item-action bg-dark text-light border-secondary py-2 {% if is_current %}active border-danger{% endif %}">
                        <div class="d-flex align-items-center">
                            <!-- Icone do tipo -->
                            <span class="me-2">
                                {% if s.tipo == 'combate' %}
                                <i class="bi bi-shield-shaded text-danger"></i>
                                {% elif s.tipo == 'puzzle' %}
                                <i class="bi bi-puzzle text-warning"></i>
                                {% elif s.tipo == 'social' %}
                                <i class="bi bi-chat-dots text-info"></i>
                                {% else %}
                                <i class="bi bi-book text-secondary"></i>
                                {% endif %}
                            </span>
                            <div class="flex-grow-1">
                                <small class="d-block {% if is_completed %}text-muted text-decoration-line-through{% endif %}">
                                    {{ s.titulo[:18] }}{% if s.titulo|length > 18 %}...{% endif %}
                                </small>
                            </div>
                            <!-- Indicador de estado -->
                            {% if is_current %}
                            <span class="badge bg-danger"><i class="bi bi-geo-alt-fill"></i></span>
                            {% elif is_completed %}
                            <span class="badge bg-success"><i class="bi bi-check"></i></span>
                            {% else %}
                            <span class="badge bg-secondary">{{ s.id }}</span>
                            {% endif %}
                        </div>
                        <!-- Linha de conexao visual -->
                        {% if not loop.last %}
                        <div class="text-center mt-1" style="opacity: 0.3;">
                            <i class="bi bi-arrow-down"></i>
                        </div>
                        {% endif %}
                    </a>
                    {% endfor %}
                </div>

                <!-- Legenda -->
                <div class="card-footer border-secondary p-2">
                    <small class="text-light opacity-75 d-block mb-1">Legenda:</small>
                    <div class="d-flex flex-wrap gap-1">
                        <span class="badge bg-dark border border-secondary" style="font-size: 0.6em;">
                            <i class="bi bi-shield-shaded text-danger me-1"></i>Combate
                        </span>
                        <span class="badge bg-dark border border-secondary" style="font-size: 0.6em;">
                            <i class="bi bi-chat-dots text-info me-1"></i>Social
                        </span>
                        <span class="badge bg-dark border border-secondary" style="font-size: 0.6em;">
                            <i class="bi bi-puzzle text-warning me-1"></i>Puzzle
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script src="{{ url_for('static', filename='js/map-grid.js') }}"></script>
{% if game_session %}
<script src="{{ url_for('static', filename='js/time-tracker.js') }}"></script>
{% endif %}
<script>
{% if game_session %}
function adicionarAoCombate(nome, hp, ac) {
    // Abrir rastreador de combate da sessao
    const url = '{{ url_for("combat.session_tracker", session_id=game_session.id) }}';
    window.open(url, '_blank');
}
{% endif %}

{% if game_session %}
function updateHp(playerId, action, amount) {
    var formData = new FormData();
    formData.append('action', action);
    formData.append('amount', amount);

    fetch('/sessao/{{ game_session.id }}/jogador/' + playerId + '/hp', {
        method: 'POST',
        body: formData,
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
        if (data.hp_atual !== undefined) {
            var hpSpan = document.getElementById('hp-' + playerId);
            hpSpan.textContent = data.hp_atual + '/' + data.hp_max;

            // Atualizar cor baseado na percentagem
            var percent = (data.hp_atual / data.hp_max) * 100;
            hpSpan.className = 'hp-display badge';
            if (percent > 50) {
                hpSpan.classList.add('bg-success');
            } else if (percent > 25) {
                hpSpan.classList.add('bg-warning');
            } else {
                hpSpan.classList.add('bg-danger');
            }

            // Atualizar barra de progresso
            var playerDiv = document.getElementById('player-' + playerId);
            var progressBar = playerDiv.querySelector('.progress-bar');
            if (progressBar) {
                progressBar.style.width = percent + '%';
                progressBar.className = 'progress-bar';
                if (percent > 50) {
                    progressBar.classList.add('bg-success');
                } else if (percent > 25) {
                    progressBar.classList.add('bg-warning');
                } else {
                    progressBar.classList.add('bg-danger');
                }
            }
        }
    });
}
{% endif %}

// ===== Inicializar Mapa Tactico =====
{% if step.mapa_tatico and game_session %}
let mapGrid;

// Inicializar mapa quando pagina carrega
document.addEventListener('DOMContentLoaded', function() {
    mapGrid = new MapGrid('tacticalMap', {
        gridWidth: {{ step.mapa_tatico.grid_largura }},
        gridHeight: {{ step.mapa_tatico.grid_altura }},
        squareSizeMeters: {{ step.mapa_tatico.metros_por_quadrado }},
        cellSize: 40,
        backgroundImage: {% if step.mapa_tatico.imagem_fundo %}'{{ step.mapa_tatico.imagem_fundo }}'{% else %}null{% endif %}
    });

    // Carregar posicoes do servidor
    fetch('/mapa/sessao/{{ game_session.id }}/passo/{{ step_id }}/posicoes')
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data.positions && data.positions.length > 0) {
                mapGrid.loadEntities(data.positions);
            } else {
                // Se nao houver posicoes, inicializar com posicoes padrao
                inicializarMapaPadrao();
            }
        })
        .catch(function(error) {
            console.error('Erro ao carregar posicoes:', error);
            inicializarMapaPadrao();
        });

    // Callback: Sincronizar movimento ao servidor
    mapGrid.onEntityMoved = function(entity) {
        fetch('/mapa/sessao/{{ game_session.id }}/passo/{{ step_id }}/mover', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                entity_id: entity.entity_id,
                x: entity.grid_x,
                y: entity.grid_y
            })
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            console.log('Posicao actualizada:', data);
        })
        .catch(function(error) {
            console.error('Erro ao actualizar posicao:', error);
        });
    };

    // Callback: Mostrar info da entidade
    mapGrid.onEntitySelected = function(entity) {
        console.log('Entidade seleccionada:', entity);
    };
});

// Funcao para inicializar mapa com posicoes padrao
function inicializarMapaPadrao() {
    {% if step.mapa_tatico.posicoes_iniciais %}
    const initialPositions = {{ step.mapa_tatico.posicoes_iniciais|tojson }};

    fetch('/mapa/sessao/{{ game_session.id }}/passo/{{ step_id }}/inicializar', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            map_config: {
                grid_largura: {{ step.mapa_tatico.grid_largura }},
                grid_altura: {{ step.mapa_tatico.grid_altura }},
                metros_por_quadrado: {{ step.mapa_tatico.metros_por_quadrado }},
                imagem_fundo: {% if step.mapa_tatico.imagem_fundo %}'{{ step.mapa_tatico.imagem_fundo }}'{% else %}null{% endif %}
            },
            initial_positions: initialPositions
        })
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
        console.log('Mapa inicializado:', data);
        if (data.positions) {
            mapGrid.loadEntities(data.positions);
        }
    })
    .catch(function(error) {
        console.error('Erro ao inicializar mapa:', error);
    });
    {% endif %}
}

// Toggle de filtros de entidades
function toggleEntityFilter(filterName) {
    if (mapGrid) {
        const currentValue = mapGrid.filters[filterName];
        mapGrid.setFilter(filterName, !currentValue);

        // Atualizar estado visual dos botoes
        const button = document.getElementById('toggle-' + filterName.replace('show', '').toLowerCase());
        if (button) {
            if (mapGrid.filters[filterName]) {
                button.classList.remove('btn-outline-success', 'btn-outline-info', 'btn-outline-danger');
                if (filterName === 'showPlayers') button.classList.add('btn-success');
                else if (filterName === 'showNPCs') button.classList.add('btn-info');
                else button.classList.add('btn-danger');
            } else {
                button.classList.remove('btn-success', 'btn-info', 'btn-danger');
                if (filterName === 'showPlayers') button.classList.add('btn-outline-success');
                else if (filterName === 'showNPCs') button.classList.add('btn-outline-info');
                else button.classList.add('btn-outline-danger');
            }
        }
    }
}

// Inicializar estado dos botoes de filtro
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('[id^="toggle-"]').forEach(function(button) {
        button.classList.remove('btn-outline-success', 'btn-outline-info', 'btn-outline-danger');
        if (button.id === 'toggle-players') button.classList.add('btn-success');
        else if (button.id === 'toggle-npcs') button.classList.add('btn-info');
        else button.classList.add('btn-danger');
    });
});
{% endif %}

// ===== Inicializar TimeTracker =====
{% if game_session %}
// Inicializar TimeTracker
const timeTracker = new TimeTracker({{ game_session.id }}, {
    autoUpdate: true,
    updateInterval: 1000,
    onError: (error) => {
        console.error('Erro no tracker de tempo:', error);
    }
});

// Configurar elementos DOM
timeTracker.setElements({
    sessionDuration: 'session-duration',
    combatTime: 'combat-time',
    explorationTurns: 'exploration-turns',
    gameTime: 'game-time'
});

// Criar controles
const controls = new TimeControlsBuilder(timeTracker);
controls.createStartPauseButton('session-controls');
controls.createCombatRoundButton('combat-controls');
controls.createExplorationButton('exploration-controls');
controls.createGameTimeButtons('game-time-controls');
controls.createRestButtons('rest-controls');

// Fazer update inicial
timeTracker.update();
{% endif %}
</script>
{% endblock %}
{% endblock %}
