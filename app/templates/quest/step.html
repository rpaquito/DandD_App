{% extends "base.html" %}

{% block title %}{{ step.titulo }} - {{ quest.titulo }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- Sidebar - Navegação -->
        <div class="col-lg-2 mb-4">
            <div class="card bg-dark border-secondary sticky-top" style="top: 20px;">
                <div class="card-header border-secondary">
                    <small><i class="bi bi-list-ol me-1"></i>Passos</small>
                </div>
                <div class="list-group list-group-flush" style="max-height: 60vh; overflow-y: auto;">
                    {% for s in quest.passos %}
                    <a href="{{ url_for('quest.step', quest_id=quest.id, step_id=s.id) }}"
                       class="list-group-item list-group-item-action bg-dark text-light border-secondary py-2 {% if s.id == step_id %}active{% endif %}">
                        <small>
                            <span class="badge {% if s.id == step_id %}bg-danger{% else %}bg-secondary{% endif %} me-1">{{ s.id }}</span>
                            {{ s.titulo[:20] }}{% if s.titulo|length > 20 %}...{% endif %}
                        </small>
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Conteúdo Principal -->
        <div class="col-lg-7">
            <!-- Navegação de Passo -->
            <nav aria-label="breadcrumb" class="mb-3">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Início</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('quest.overview', quest_id=quest.id) }}">{{ quest.titulo }}</a></li>
                    <li class="breadcrumb-item active">Passo {{ step_id }}</li>
                </ol>
            </nav>

            <!-- Cabeçalho do Passo -->
            <div class="card bg-dark border-secondary mb-4">
                <div class="card-header border-secondary d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <span class="badge bg-danger me-2">{{ step_id }}</span>
                        {{ step.titulo }}
                    </h4>
                    <span class="badge bg-{% if step.tipo == 'combate' %}danger{% elif step.tipo == 'puzzle' %}warning{% elif step.tipo == 'social' %}info{% else %}secondary{% endif %}">
                        {% if step.tipo == 'combate' %}<i class="bi bi-shield-shaded me-1"></i>Combate
                        {% elif step.tipo == 'puzzle' %}<i class="bi bi-puzzle me-1"></i>Puzzle
                        {% elif step.tipo == 'social' %}<i class="bi bi-chat-dots me-1"></i>Social
                        {% else %}<i class="bi bi-book me-1"></i>Narrativa{% endif %}
                    </span>
                </div>
            </div>

            <!-- Texto para Ler aos Jogadores -->
            <div class="card bg-dark border-warning mb-4">
                <div class="card-header border-warning bg-warning bg-opacity-10">
                    <h5 class="mb-0 text-warning">
                        <i class="bi bi-megaphone me-2"></i>Ler aos Jogadores
                    </h5>
                </div>
                <div class="card-body">
                    <div class="player-text fs-5" style="line-height: 1.8;">
                        {{ step.texto_jogadores|safe }}
                    </div>
                </div>
            </div>

            <!-- Notas do Mestre -->
            {% if step.notas_mestre %}
            <div class="card bg-dark border-info mb-4">
                <div class="card-header border-info bg-info bg-opacity-10">
                    <h5 class="mb-0 text-info">
                        <i class="bi bi-journal-text me-2"></i>Notas do Mestre
                        <small class="text-muted">(Só para ti)</small>
                    </h5>
                </div>
                <div class="card-body">
                    {{ step.notas_mestre|safe }}
                </div>
            </div>
            {% endif %}

            <!-- Dicas de Improvisação -->
            {% if step.dicas_improvisacao %}
            <div class="card bg-dark border-success mb-4">
                <div class="card-header border-success bg-success bg-opacity-10">
                    <h5 class="mb-0 text-success">
                        <i class="bi bi-lightbulb me-2"></i>Dicas de Improvisação
                    </h5>
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        {% for dica in step.dicas_improvisacao %}
                        <li class="mb-2">{{ dica }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}

            <!-- Navegação entre Passos -->
            <div class="d-flex justify-content-between mt-4">
                {% if step_id > 1 %}
                <a href="{{ url_for('quest.step', quest_id=quest.id, step_id=step_id - 1) }}" class="btn btn-outline-light">
                    <i class="bi bi-arrow-left me-1"></i>Passo Anterior
                </a>
                {% else %}
                <span></span>
                {% endif %}

                {% if step.proximos_passos %}
                <div class="btn-group">
                    {% for next_id in step.proximos_passos %}
                    {% set next_step = quest.get_step(next_id) %}
                    <a href="{{ url_for('quest.step', quest_id=quest.id, step_id=next_id) }}" class="btn btn-danger">
                        {{ next_step.titulo if next_step else 'Passo ' + next_id|string }}
                        <i class="bi bi-arrow-right ms-1"></i>
                    </a>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Painel Lateral - Contexto -->
        <div class="col-lg-3">
            <!-- NPCs Presentes -->
            {% set npcs_presentes = quest.get_npcs_for_step(step) %}
            {% if npcs_presentes %}
            <div class="card bg-dark border-secondary mb-4">
                <div class="card-header border-secondary">
                    <h6 class="mb-0"><i class="bi bi-people me-2"></i>NPCs Presentes</h6>
                </div>
                <div class="list-group list-group-flush">
                    {% for npc in npcs_presentes %}
                    <div class="list-group-item bg-dark text-light border-secondary">
                        <h6 class="mb-1">{{ npc.nome }}</h6>
                        <small class="text-muted">{{ npc.descricao[:80] }}{% if npc.descricao|length > 80 %}...{% endif %}</small>
                        {% if npc.dialogos %}
                        <button class="btn btn-sm btn-outline-info mt-2 w-100" data-bs-toggle="collapse" data-bs-target="#dialogos-{{ npc.id }}">
                            <i class="bi bi-chat-quote me-1"></i>Ver Diálogos
                        </button>
                        <div class="collapse mt-2" id="dialogos-{{ npc.id }}">
                            <ul class="list-unstyled small">
                                {% for dialogo in npc.dialogos %}
                                <li class="mb-1 fst-italic">"{{ dialogo }}"</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Monstros no Passo -->
            {% set monstros_presentes = quest.get_monsters_for_step(step) %}
            {% if monstros_presentes %}
            <div class="card bg-dark border-danger mb-4">
                <div class="card-header border-danger">
                    <h6 class="mb-0"><i class="bi bi-bug me-2"></i>Monstros</h6>
                </div>
                <div class="list-group list-group-flush">
                    {% for monster in monstros_presentes %}
                    <div class="list-group-item bg-dark text-light border-secondary">
                        <div class="d-flex justify-content-between">
                            <h6 class="mb-1">{{ monster.nome }}</h6>
                            <span class="badge bg-danger">CR {{ monster.cr }}</span>
                        </div>
                        <div class="small">
                            <span class="me-2"><i class="bi bi-shield me-1"></i>AC {{ monster.ac }}</span>
                            <span><i class="bi bi-heart me-1"></i>{{ monster.hp_max }} HP</span>
                        </div>
                        <button class="btn btn-sm btn-outline-danger mt-2 w-100" onclick="adicionarAoCombate('{{ monster.nome }}', {{ monster.hp_max }}, {{ monster.ac }})">
                            <i class="bi bi-plus-circle me-1"></i>Adicionar ao Combate
                        </button>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Atalho para Combate -->
            {% if step.tipo == 'combate' %}
            <div class="card bg-danger bg-opacity-25 border-danger">
                <div class="card-body text-center">
                    <i class="bi bi-shield-shaded display-4 mb-2"></i>
                    <h5>Cena de Combate</h5>
                    <a href="{{ url_for('combat.tracker') }}" class="btn btn-danger w-100" target="_blank">
                        <i class="bi bi-box-arrow-up-right me-1"></i>Abrir Rastreador
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{% block extra_js %}
<script>
function adicionarAoCombate(nome, hp, ac) {
    // Abrir rastreador de combate com dados pré-preenchidos
    const url = '{{ url_for("combat.tracker") }}?add=' + encodeURIComponent(nome) + '&hp=' + hp + '&ac=' + ac;
    window.open(url, '_blank');
}
</script>
{% endblock %}
{% endblock %}
